<% provide(:title, "Reports") %>
<section>
  <h1 class="text-center py-4 fw-bold">Popular Hours</h1>

  <%= form_tag admin_report_generator_popular_hours_per_period_path(space_id: @space.id), method: :get do %>
    <div style=" display: flex; justify-content: center;">
      <div class="row align-items-center">
        <div class="mb-3 col-md-4" style="width: 300px">
          <%= label_tag(:start_date, "From", class:"form-label") %>
          <%= date_field_tag(:start_date, 1.month.ago.beginning_of_month.strftime("%Y-%m-%d"), class: %w(form-control range-type-date-range-fields)) %>
        </div>

        <div class="mb-3 col-md-4" style="width: 300px">
          <%= label_tag(:end_date, "To", class:"form-label") %>
          <%= date_field_tag(:end_date, DateTime.now.strftime("%Y-%m-%d"), class: %w(form-control range-type-date-range-fields)) %>
        </div>

        <div class="mb-3 col-md-4">
          <label for="end_date">Start</label>
          <br>
          <%= button_tag("Generate", {class: "btn btn-primary"}) %>
        </div>

      </div>
    </div>

  <% end %>

  <ul class="nav nav-tabs">
    <% @spaces.each do |space| %>
      <li class="nav-item">
        <a class="nav-link  <%= @space.name == space.name ? "active" : "" %>" data-bs-toggle="tab" href="#<%= space.name.gsub(" ", "-") %>"><%= space.name %></a>
      </li>
    <% end %>
  </ul>

  <div class="tab-content">
    <% @spaces.each do |space| %>
      <div class="tab-pane container <%= @space.name == space.name ? "active" : "" %>" id="<%= space.name.gsub(" ", "-") %>">
        <br>
        <% popular_hours = PopularHour.from_space(space.id) %>

        <span style="text-align: center!important; display: block;">The following stats are being updated automatically over time. It takes the average per hour for every day of the week and every spaces.</span>
        <div class="row">
          <% (0..6).each do |weekday| %>
            <% popular_hour = popular_hours.where(day: weekday) %>
            <br>

            <% if popular_hour.present? %>

              <div class="col-4">
                <h3 class="text-center"><%= @weekdays[popular_hour.first.day] if popular_hour.present? %></h3>
                <canvas id="<%= space.name.gsub(" ", "-") %>-<%= popular_hour.first.day if popular_hour.present? %>" width="450" height="300"></canvas>
              </div>
              <script type="text/javascript" charset="utf-8">
                  var ctx = document.getElementById('<%= space.name.gsub(" ", "-") %>-<%= popular_hour.first.day if popular_hour.present? %>').getContext('2d');
                  var myChart = new Chart(ctx, {
                      type: 'bar',
                      data: {
                          labels: ['0h', '1h', '2h', '3h', '4h', '5h', '6h', '7h', '8h', '9h', '10h', '11h', '12h', '13h', '14h', '15h', '16h', '17h', '18h', '19h', '20h', '21h', '22h', '23h'],
                          datasets: [{
                              label: '# of people',
                              data: <%= popular_hour.pluck(:mean) %>,
                              backgroundColor: '#6db1f5',
                              borderWidth: 1
                          }]
                      },
                      options: {
                          scales: {
                              yAxes: [{
                                  ticks: {
                                      beginAtZero: true
                                  }
                              }]
                          }
                      }
                  });
              </script>

            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
    <br>
  </div>

</section>